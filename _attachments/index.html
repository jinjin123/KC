<!DOCTYPE html>
<html>
    <head>
        <title>KC</title>
        <link rel="stylesheet" href="style/main.css" type="text/css">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    </head>
    <body>
        <h1>KC 3.0.15</h1>
        <div id="main">
            <ul>
                <li>
                    <input id="storeid" type="text"> 
                    <button id="set_storeid">Set Store ID</button> 
                    <span id="result"></span>     
                    <a href="/_utils/database.html?orders" target="_blank">CouchDB UI</a>
                    <button id="start-kc">Start KC</button>
                </li>
                <li>
                    <a href="kc.config.json" target="_blank">Pre-processing configuration</a>
                    <a name="config" class="url" href="/orders/_local/configuration" target="_blank">Post-processing configuration</a>
                </li>
                <li>
                    <a name="conflicts" class="url" href="/orders/_design/kc/_view/conflicts" target="_blank">Conflicting orders</a>
                    <a name="success" class="url" href="/orders/_design/kc/_view/status?startkey=[1,0]&endkey=[1,100]&include_docs=true&conflicts=true" target="_blank">Synchronized orders</a>
                    <a name="waiting" class="url" href="/orders/_design/kc/_view/status?startkey=[0,3]&endkey=[0,100]&include_docs=true&conflicts=true" target="_blank">New orders</a>
                    <a name="failed" class="url" href="/orders/_design/kc/_view/status?startkey=[2,3]&endkey=[99999,100]&include_docs=true&conflicts=true" target="_blank">Failed orders</a>
                </li>
                <li>
                    <span>Date range</span>
                    <input id="date_range" type="number" value="1"/>
                    <span>Sync status</span>
                    <input id="sync_status" type="number" value="2"/>
                    <span>Order status</span>
                    <input id="order_status" type="number" value="3"/>                    
                    <button id="search">Search</button>
                </li>
                <li>
                    <button id="comparePOS">Compare to POS</button>
                </li>
                <li>
                    <label>Order ID</label>
                    <input id="orderid" type="text"> 
                    <button id="query_order_oc">Query order from OC</button>
                    <label>Revision Number</label>
                    <input id="rev" type="text"> 
                    <button id="query_order_kc">Query order from KC</button>
                </li>
                <li>
                    Scan database: success <span id='scan_db_success'>0</span> times, fail <span id='scan_db_fail'>0</span> times
                </li>
                <li>
                    Stomp: <span id='stomp_info'></span>
                </li>
            </ul>

        </div>
    </body>
    <script src='script/jquery-3.1.1.js'></script>    
    <script src='script/moment.min.js'></script>    
    
    <script src="script/sha1.js"></script>
    <script src="script/json2.js"></script>
    <script src="script/jquery.couch.js"></script>
    
    <script src="vendor/couchapp/jquery.couchLogin.js"></script>
    <script src="vendor/couchapp/jquery.couchProfile.js"></script>
    <script src="vendor/couchapp/md5.js"></script>
    <!--script src="vendor/couchapp/jquery.mustache.js"></script-->
      
    <script src="script/stomp.js"></script>
    <!--script src="script/mustache-2.3.0.js"></script-->
    <script src="script/app.js"></script>
    <script src="script/pouchdb-6.0.7.js"></script>
    <script src="script/OC.js"></script>
    <script src="script/orderMap.js"></script>
    <script type="application/javascript">

        $(document).ready(function() {
            loadConfig(function(cfg) {
                window.CONFIG = cfg;
                console.log("cfg++++++++++++++++++++++++++");
                console.log(cfg);
                $('#storeid').val(cfg['store-id']);          
                
                function log_result(data, err){
                    if(data){
                        alert("success\n" + JSON.stringify(data));
                    } else {
                        alert("failed\n" + JSON.stringify(err));
                    }                     
                }
                $('#start-kc').click(function(){
                    //receiveOC(cfg);
                    //scanOrders($('#date_range').val(), cfg);
                    //scanDatabase($('#date_range').val(), cfg);
                    multipleAjax($('#date_range').val(), cfg).run();    
                });                
                $('#search').click(function(){
                    var today = new Date();
                    var yesterday = new Date();
                    var days = $('#date_range').val();
                    var sync_status = $('#sync_status').val();
                    var order_status = $('#order_status').val();
                    yesterday.setDate(yesterday.getDate()-days);
                    today = encodeURI(getDate(today));
                    yesterday = encodeURI(getDate(yesterday));
                    window.open("/orders/_design/kc/_view/timestatus?startkey=[\""+yesterday+"\","+sync_status+","+order_status+"]&endkey=[\""+today+"\",9999,100]&include_docs=true&conflicts=true",'_blank');
                });
                $('#comparePOS').click(function(){
                    if(!window.mq) {
                        window.mq = receivePOS(cfg, function (msg){
                            console.log(msg);
                        }, function(err){
                            delete window.mq;
                            console.log(err);
                        });
                    } else {
                        window.mq.send('all', 'query', {
                            type:"request",
                            from:"kc2",
                            to:"all",
                            reply_to:"kc2",
                            id:"asdf",
                            data:{
                                command:"orderList",
                                arguments:[getDate(new Date(), 'YYYY-MM-DD')]
                            }
                        });
                        window.mq.send('all', 'query', {
                            type:"request",
                            from:"kc2",
                            to:"all",
                            reply_to:"kc2",
                            id:"asdf",
                            data:{
                                command:"orderDetail",
                                arguments:['SP000001201701113742']
                            }
                        });                        
                    }
                });                

                $('#set_storeid').click(function() {
                    setLocal('store-id', $('#storeid').val(), function(data, err) {
                        if(!data){
                            $("#result").html(JSON.stringify(err));
                        } else {
                            loadConfig(function(cfg){
                                setLocal("configuration", cfg, function(data, err){
                                    console.log(data ? data : err);
                                });
                            }); 
                        }
                    });
                });
                $('#query_order_oc').click(function() {
                    window.location.href = getOCQueryURL(cfg, $('#orderid').val());
                });
                $('#query_order_kc').click(function() {
                    if ($('#rev').val()) {
                        window.location.href  = '/orders/'+ $('#orderid').val() + '?rev=' + $('#rev').val();
                    } else {
                        window.location.href  = '/orders/'+ $('#orderid').val();                        
                    }
                });

                //var db = new PouchDB('orders');
                /*
                //use store-id as the beginning of routine key

                //use
                
                PouchDB.sync('orders', 'http://172.28.13.199:5984/orders',{
                    live: true,
                    retry: true
                }).on('change', function (info) {
                    console.log('change', info);
                  // handle change
                }).on('paused', function (err) {
                    console.log('paused', err)
                  // replication paused (e.g. replication up to date, user went offline)
                }).on('active', function () {
                    console.log('active');
                  // replicate resumed (e.g. new changes replicating, user went back online)
                }).on('denied', function (err) {
                    console.log('denied', err);
                  // a document failed to replicate (e.g. due to permissions)
                }).on('complete', function (info) {
                    console.log('complete', info);
                  // handle complete
                }).on('error', function (err) {
                    console.log('error', err);
                  // handle error
                });
                                
                db.changes({
                    since: 1,
                    live: true,
                    include_docs: true
                }).on('change', function(ch){
                    console.log('onchange', ch);
                }).on('error', function(err){
                    console.log('onerror', err);
                });
                */
                /*
                $('#add_data').click(function(){
                    db.post({
                        title: 'Heroes'
                    }, function(err, response) {
                        console.log(err, response)
                    });                    
                });
                */
            });
        });
    </script>
</html>

<!DOCTYPE html>
<html>
    <head>
        <title>KC 3.0.0</title>
        <link rel="stylesheet" href="style/main.css" type="text/css">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    </head>
    <body>
        <h1>KC 3.0.0</h1>

        <div id="main">
            <ul>
                <li>
                    <input id="storeid" type="text"> 
                    <button id="set_storeid">Set Store ID</button>   
                    <span id="result"></span>     
                    <label>Delete conflicting records</label>
                    <input id='resolve-conflicts' type="checkbox"/>      
                    <a href="/_utils/database.html?orders">CouchDB UI</a>      
                </li>
                <li>
                    <a href="kc.config.json">Current Configuration</a>
                    <a name="conflicts" class="url" href="/orders/_design/kc/_view/conflicts">Orders that have conflicts</a>
                    <a name="success" class="url" href="/orders/_design/kc/_view/status?startkey=[1,0]&endkey=[1,100]&include_docs=true&conflicts=true">Order that has been sent to OC</a>
                    <a name="waiting" class="url" href="/orders/_design/kc/_view/status?startkey=[0,4]&endkey=[0,100]&include_docs=true&conflicts=true">Order that is waiting to synchronize with OC</a>
                </li>
                <li>
                    <button id="cleanAll">Delete all orders</button>
                    <button id="clean">Delete order that is older than a month</button>
                    <button id="compact">Compact database</button>
                    <button id="release">Synchronize software</button>
                    <button id="compareOC">Compare data with OC</button>
                    <button id="comparePOS">Compare data with POS</button>                    
                </li>
                <li>
                    <a name="failed" class="url" href="/orders/_design/kc/_view/status?startkey=[2,4]&endkey=[99999,100]&include_docs=true&conflicts=true">Order that has failed to synchronize with OC</a>
                    <span>                  </span>
                    <button id="retry_failed_orders">Retry</button>
                </li>
                <li>
                    <label>Order ID</label>
                    <input id="orderid" type="text"> 
                    <button id="query_order_oc">Query order from OC</button>
                    <label>Revision Number</label>
                    <input id="rev" type="text"> 
                    <button id="query_order_kc">Query order from KC</button>
                </li>
                <li>
                    Scan database: success <span id='scan_db_success'>0</span> times, fail <span id='scan_db_fail'>0</span> times
                </li>
                <li>
                    Stomp: <span id='stomp_info'></span>
                </li>
            </ul>
        </div>
    </body>
    <script src='script/jquery-3.1.1.js'></script>    
    <script src='script/moment.min.js'></script>    
    
    <script src="/_utils/script/sha1.js"></script>
    <script src="/_utils/script/json2.js"></script>
    <script src="/_utils/script/jquery.couch.js"></script>
    
    <script src="vendor/couchapp/jquery.couchLogin.js"></script>
    <script src="vendor/couchapp/jquery.couchProfile.js"></script>
    <script src="vendor/couchapp/md5.js"></script>
    <script src="vendor/couchapp/jquery.mustache.js"></script>
      
    <script src="script/stomp.js"></script>
    <script src="script/mustache-2.3.0.js"></script>
    <script src="script/app.js"></script>
    <script src="script/pouchdb-6.0.7.js"></script>
    <script type="application/javascript">

        $(document).ready(function() {
            loadConfig(function(cfg) {
                window.CONFIG = cfg;
                receiveOC(cfg);
                getLocal('resolve-conflicts', function(data, err){
                    scanOrders(cfg, data);
                    $('#resolve-conflicts').get(0).checked = data;
                    $('#resolve-conflicts').click(function(){
                        setLocal('resolve-conflicts', $('#resolve-conflicts').get(0).checked, function(){
                            document.location = document.location;
                        });
                    });
                });
                
                getLocal('store-id', function(data, err) {
                    if(data){
                        $('#storeid').val(data);
                    } else {
                        $("#result").text(JSON.stringify(err));
                    }
                });
                $('#compact').click(function(){
                    compact(function(data, err){
                        if(err){
                            alert(JSON.stringify(err));
                            //console.log(err);
                        } else {
                            alert(JSON.stringify(data));
                            //console.log(data);
                        } 
                    });
                });
                $('#release').click(function(){
                    deploy(function(data, err){
                        if(err){
                            alert(JSON.stringify(err));
                            //console.log(err);
                        } else {
                            alert(JSON.stringify(data));
                            //console.log(data);
                        } 
                    });
                });
                $('#compareOC').click(function(){
                    compareOC(cfg, function(data, err){
                        if(err){
                            alert(JSON.stringify(err));
                            //console.log(err);
                        } else {
                            alert(JSON.stringify(data));
                            //console.log(data);
                        }                         
                    })
                });
                $('#comparePOS').click(function(){

                });                
                $('#cleanAll').click(function(){
                    orders('status?endkey=[9999,9999]', function(data, err){
                        if(data){
                            deleteOrders(data, function (d, e){
                                if(d){
                                    alert("success");
                                } else {
                                    console.log(e);
                                    alert('failed');
                                }                                
                            })
                        } else {
                            console.log(err);
                        }
                    })
                });
                $('#clean').click(function(){
                    ordersBefore(30, function(data, err){
                        if(data){
                            deleteOrders(data, function(d, e){
                                if(d){
                                    alert("success");
                                } else {
                                    console.log(e);
                                    alert('failed');
                                }
                            });
                        } else {
                            console.log(err);
                        }
                    });
                });
                $('#retry_failed_orders').click(function () {
                    retryFailed(cfg, function(err){
                        if(err){
                            alert(err);
                        } else {
                            alert('Operation finished');
                        }
                    });
                });
                $('#set_storeid').click(function() {
                    setLocal('store-id', $('#storeid').val(), function(data, err) {
                        if(!data){
                            $("#result").html(JSON.stringify(err));
                        }
                    });
                })
                $('#query_order_oc').click(function() {
                    window.location.href = getOCQueryURL(cfg, $('#orderid').val());
                });
                $('#query_order_kc').click(function() {
                    if ($('#rev').val()) {
                        window.location.href  = '/orders/'+ $('#orderid').val() + '?rev=' + $('#rev').val();
                    } else {
                        window.location.href  = '/orders/'+ $('#orderid').val();                        
                    }
                });

                //var db = new PouchDB('orders');
                /*
                PouchDB.sync('orders', 'http://172.28.13.199:5984/orders',{
                    live: true,
                    retry: true
                }).on('change', function (info) {
                    console.log('change', info);
                  // handle change
                }).on('paused', function (err) {
                    console.log('paused', err)
                  // replication paused (e.g. replication up to date, user went offline)
                }).on('active', function () {
                    console.log('active');
                  // replicate resumed (e.g. new changes replicating, user went back online)
                }).on('denied', function (err) {
                    console.log('denied', err);
                  // a document failed to replicate (e.g. due to permissions)
                }).on('complete', function (info) {
                    console.log('complete', info);
                  // handle complete
                }).on('error', function (err) {
                    console.log('error', err);
                  // handle error
                });
                                
                db.changes({
                    since: 1,
                    live: true,
                    include_docs: true
                }).on('change', function(ch){
                    console.log('onchange', ch);
                }).on('error', function(err){
                    console.log('onerror', err);
                });
                */
                /*
                $('#add_data').click(function(){
                    db.post({
                        title: 'Heroes'
                    }, function(err, response) {
                        console.log(err, response)
                    });                    
                });
                */
            });
        });
    </script>
</html>
